<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Potts Sampling Force Animation</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #0f172a;
      color: #e2e8f0;
    }
    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }
    #info {
      padding: 12px 20px;
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    #info-text {
      font-size: 15px;
      font-weight: 500;
    }
    #controls {
      display: flex;
      gap: 8px;
    }
    #controls button {
      background: rgba(59, 130, 246, 0.25);
      border: 1px solid rgba(96, 165, 250, 0.4);
      color: #e0f2fe;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s, border 0.2s;
    }
    #controls button:hover:not(:disabled) {
      background: rgba(59, 130, 246, 0.45);
      border-color: rgba(96, 165, 250, 0.7);
    }
    #controls button:disabled {
      opacity: 0.35;
      cursor: not-allowed;
    }
    #viz {
      flex: 1;
    }
    #legend {
      padding: 10px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      background: rgba(15, 23, 42, 0.85);
      border-top: 1px solid rgba(148, 163, 184, 0.2);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }
    .legend-swatch {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }
    .legend-edge {
      width: 28px;
      height: 0;
      border-bottom: 3px solid #94a3b8;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="info">
      <div id="info-text">Loading sampling trajectory…</div>
      <div id="controls">
        <button id="prev-frame" type="button" disabled>◀ Back</button>
        <button id="next-frame" type="button" disabled>Forward ▶</button>
      </div>
    </div>
    <div id="viz"></div>
    <div id="legend"></div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" integrity="sha512-M7nHCiNUOwFt6Us3r8alutZLm9qMt4s9951uo8jqO4UwJ1hziseL6O3ndFyigx6+LREfZqnhHxYjKRJ8ZQ69DQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    const data = {"datasetName": "fcc-seed87-st5-ch10", "nodes": [{"id": 0, "stationId": 87}, {"id": 1, "stationId": 38214}, {"id": 2, "stationId": 50194}, {"id": 3, "stationId": 50205}, {"id": 4, "stationId": 66414}], "links": [{"source": 0, "target": 1, "typeTags": ["CO"]}, {"source": 0, "target": 2, "typeTags": ["ADJ+1", "ADJ-1", "CO"]}, {"source": 0, "target": 3, "typeTags": ["CO"]}, {"source": 0, "target": 4, "typeTags": ["CO"]}, {"source": 1, "target": 2, "typeTags": ["CO"]}, {"source": 1, "target": 3, "typeTags": ["CO"]}, {"source": 2, "target": 3, "typeTags": ["CO"]}, {"source": 2, "target": 4, "typeTags": ["CO"]}, {"source": 3, "target": 4, "typeTags": ["CO"]}], "channelLabels": [2, 3, 4, 5, 6, 7, 8, 9, 10, 11], "frames": [{"step": 0, "energy": 2.0, "edgeConflicts": 2, "domainViolations": 0, "colors": [7, 6, 6, 9, 2], "conflictMask": [0, 1, 0, 0, 1, 0, 0, 0, 0]}, {"step": 1, "energy": 3.0, "edgeConflicts": 3, "domainViolations": 0, "colors": [5, 6, 3, 3, 3], "conflictMask": [0, 0, 0, 0, 0, 0, 1, 1, 1]}, {"step": 2, "energy": 6.0, "edgeConflicts": 6, "domainViolations": 0, "colors": [3, 4, 4, 4, 4], "conflictMask": [0, 1, 0, 0, 1, 1, 1, 1, 1]}, {"step": 3, "energy": 3.0, "edgeConflicts": 3, "domainViolations": 0, "colors": [4, 6, 4, 0, 4], "conflictMask": [0, 1, 0, 1, 0, 0, 0, 1, 0]}, {"step": 4, "energy": 6.0, "edgeConflicts": 6, "domainViolations": 0, "colors": [3, 4, 4, 4, 4], "conflictMask": [0, 1, 0, 0, 1, 1, 1, 1, 1]}, {"step": 5, "energy": 4.0, "edgeConflicts": 4, "domainViolations": 0, "colors": [3, 9, 4, 4, 4], "conflictMask": [0, 1, 0, 0, 0, 0, 1, 1, 1]}, {"step": 6, "energy": 2.0, "edgeConflicts": 2, "domainViolations": 0, "colors": [1, 1, 7, 7, 2], "conflictMask": [1, 0, 0, 0, 0, 0, 1, 0, 0]}, {"step": 7, "energy": 0.0, "edgeConflicts": 0, "domainViolations": 0, "colors": [5, 8, 3, 0, 0], "conflictMask": [0, 0, 0, 0, 0, 0, 0, 0, 0]}]};

    const width = Math.max(960, window.innerWidth);
    const height = Math.max(600, window.innerHeight - 160);

    const nodes = data.nodes.map(d => Object.assign({}, d));
    const links = data.links.map(d => Object.assign({}, d));
    const frames = data.frames;
    const channelLabels = data.channelLabels;
    const datasetName = data.datasetName || "unknown";

    const defaultLinkColor = "#94a3b8";
    const highlightLinkColor = "#f97316";
    const conflictLinkColor = "#ef4444";

    const baseColors = (d3.schemeTableau10 || []).concat(d3.schemeSet3 || []);

    function colorForIndex(idx) {
      if (idx == null || idx < 0) {
        return "#64748b";
      }
      if (idx < baseColors.length) {
        return baseColors[idx];
      }
      const hue = (idx * 137.508) % 360;
      return d3.hsl(hue, 0.55, 0.55).formatHex();
    }

    function channelLabel(idx) {
      const label = channelLabels[idx];
      return label === undefined ? ("c" + idx) : label;
    }

    function hasAdjPlus(d) {
      return (d.typeTags || []).includes("ADJ+1");
    }

    function linkBaseColor(d) {
      return hasAdjPlus(d) ? highlightLinkColor : defaultLinkColor;
    }

    function linkBaseWidth(d) {
      return hasAdjPlus(d) ? 2.4 : 1.2;
    }

    function linkDash(d) {
      return hasAdjPlus(d) ? "4,3" : "none";
    }

    const svg = d3.select("#viz")
      .append("svg")
      .attr("viewBox", [0, 0, width, height])
      .attr("width", width)
      .attr("height", height);

    const link = svg.append("g")
      .attr("stroke-linecap", "round")
      .selectAll("line")
      .data(links)
      .join("line")
      .attr("stroke-opacity", 0.9)
      .attr("stroke", d => linkBaseColor(d))
      .attr("stroke-dasharray", d => linkDash(d))
      .attr("stroke-width", d => linkBaseWidth(d));

    link.append("title")
      .text(d => {
        const tags = d.typeTags || [];
        return tags.length ? "Constraints: " + tags.join(", ") : "Constraint";
      });

    const sim = createSimulation();

    const node = svg.append("g")
      .selectAll("g")
      .data(nodes)
      .join("g")
      .call(drag(sim));

    node.append("circle")
      .attr("r", 14)
      .attr("stroke", "#0f172a")
      .attr("stroke-width", 2);

    node.append("text")
      .attr("x", 0)
      .attr("y", 4)
      .attr("text-anchor", "middle")
      .attr("fill", "#f8fafc")
      .attr("font-size", 12)
      .attr("font-weight", 600);

    node.append("title")
      .text(d => "Station " + d.stationId);

    const infoText = d3.select("#info-text");
    const prevButton = document.getElementById("prev-frame");
    const nextButton = document.getElementById("next-frame");

    function createSimulation() {
      return d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120).strength(0.2))
        .force("charge", d3.forceManyBody().strength(-180))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide(36))
        .on("tick", ticked);
    }

    function ticked() {
      link
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);

      node.attr("transform", d => `translate(${d.x}, ${d.y})`);
    }

    function drag(sim) {
      function dragstarted(event) {
        if (!event.active) sim.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }

      function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }

      function dragended(event) {
        if (!event.active) sim.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }

      return d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended);
    }

    function renderLegend() {
      const legend = d3.select("#legend");
      legend.selectAll("*").remove();

      channelLabels.forEach((label, idx) => {
        const item = legend.append("div").attr("class", "legend-item");
        item.append("div")
          .attr("class", "legend-swatch")
          .style("background-color", colorForIndex(idx));
        item.append("span").text("Channel " + label + " (idx " + idx + ")");
      });

      const adjItem = legend.append("div").attr("class", "legend-item");
      adjItem.append("div")
        .attr("class", "legend-edge")
        .style("border-bottom", "3px dotted " + highlightLinkColor);
      adjItem.append("span").text("Edge includes ADJ+1 constraint (dotted)");

      const conflictItem = legend.append("div").attr("class", "legend-item");
      conflictItem.append("div")
        .attr("class", "legend-edge")
        .style("border-bottom", "3px solid " + conflictLinkColor);
      conflictItem.append("span").text("Edge currently in conflict (red)");
    }

    function formatSummary(frame) {
      return [
        "Dataset " + datasetName,
        "Step " + frame.step,
        "Energy " + frame.energy.toFixed(2),
        "Edge Conflicts " + frame.edgeConflicts,
        "Domain Violations " + frame.domainViolations
      ].join(" • ");
    }

    function updateFrame(frame) {
      infoText.text(formatSummary(frame) + " • ←/→ or buttons to navigate");

      node.select("circle")
        .attr("fill", d => colorForIndex(frame.colors[d.id]));

      node.select("text")
        .text(d => d.stationId + " (" + channelLabel(frame.colors[d.id]) + ")");

      const conflictMask = frame.conflictMask || [];
      link
        .attr("stroke", (d, i) => conflictMask[i] ? conflictLinkColor : linkBaseColor(d))
        .attr("stroke-width", (d, i) => conflictMask[i] ? 2.8 : linkBaseWidth(d));
    }

    let frameIndex = 0;

    function updateControls() {
      if (!frames.length) {
        prevButton.disabled = true;
        nextButton.disabled = true;
        return;
      }
      prevButton.disabled = frameIndex <= 0;
      nextButton.disabled = frameIndex >= frames.length - 1;
    }

    function goToFrame(index) {
      if (!frames.length) {
        infoText.text("No frames recorded.");
        updateControls();
        return;
      }
      frameIndex = Math.max(0, Math.min(index, frames.length - 1));
      updateFrame(frames[frameIndex]);
      updateControls();
    }

    function stepFrame(delta) {
      goToFrame(frameIndex + delta);
    }

    prevButton.addEventListener("click", () => stepFrame(-1));
    nextButton.addEventListener("click", () => stepFrame(1));

    document.addEventListener("keydown", event => {
      const tag = (event.target && event.target.tagName) || "";
      if (["INPUT", "TEXTAREA", "SELECT"].includes(tag)) {
        return;
      }
      if (event.key === "ArrowLeft") {
        event.preventDefault();
        stepFrame(-1);
      } else if (event.key === "ArrowRight") {
        event.preventDefault();
        stepFrame(1);
      }
    });

    renderLegend();
    goToFrame(0);
  </script>
</body>
</html>
